language: python
dist: xenial
os: linux
services:
- docker
python:
- 3.6
git:
  depth: 25
branches:
  only:
  - develop
  - "/^feature_.*/"
  - "/^main_.*/"
  - "/^bugfix_.*/"
cache:
- pip
env:
  global:
  - DO_GIT_CLONE=false
  - REPO_NAME=METplus-dev
  - REPO_NAME_lc=metplus-dev
  - CURRENT_BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH}
  - GH_PAGES_DIR=${HOME}/gh-pages
  - PYTHON_PACKAGES="requests"
  - OWNER_BUILD_DIR=`dirname ${TRAVIS_BUILD_DIR}`
  - DOCKER_WORK_DIR=/metplus
  - GITHUB_REPO_ORG=DTCenter
  - DOCKERHUB_DEFAULT_REPO=dtcenter/metplus-dev
  - DOCKERHUB_DEFAULT_TAGNAME=develop
  - DOCKERHUB_MET_TAGNAME=develop
  - DOCKER_DATA_DIR=/data
  - DOCKERHUB_USER_REPO="`dirname ${TRAVIS_REPO_SLUG}| awk '{print tolower($0)}'`/metplus"
  - DOCKERHUB_USER_TAGNAME=develop
  - DOCKERHUB_USE_DEFAULT=true
  - secure: OAiguCkrpMAKzU2p7ucTHrdCUuej9X5Un496JBF5bApYMjnRd44V+tehNHHbaVKjJNzLXf0/uJ3K47BwWCQDIK2b2JWchS6kVRPFW6YHsYUQjLE7aMsLD/+ouQ41dJyfsNB2VgQ2sO1doZIx1YKWTF7/BiB/HVh0p1qeZJOGFEBLktKPOz0LCvRlYdgUJ36vbqoLxb1bF4ENbVNNt2nmNBq9JCaLkh0A/xJgT/C+kDhj5yg10p1+RKye3VS+92WwUOYlVdCVrQIdq9LlQd/Zm1Tr/LewpGFXkwAAb0TYXKrjdH2IMO6HlfNRssvAG4Wk8Ol+NwnZFt8TDn5EZ+V0OeTSr0M9ndJuMpxyCfCEM9ouiIGW1ECBvFZT0mCOX6QE/+z1VFYKuqcEHiMT/zVbSTzhXntyqteWb7VRn9H4CvS5Jh+/1Gw0ompqtMSNYWjtWLAP91ODpSAfztsMz0uUF+Uh/OA4cOVTnIUSuPe5oeF9GS8q6jmrGCrWnqJP2hL3dC1Q0b/VUrevkHyTzZL76B1ttLfP9uYHE00xwc+zCUAC+LvIsTMcPmZlxB5TYhyw8eDTvx4xKeV1W8zyHPMlCxwhaCwygt3x1X6nyaMrOgoiQO4V3dmPw7gsUJJNJx/L47YnT/Wkz8jvofr69+DmZnhUADlnZHLbem/Vg4tb/4o=
  - secure: E/aVc0Vaudf4h5KY/lqU+kSvpJGaFov7y3VuzOgJUs3CkPL/mpxM1gT9vvuq0P2SaxLubVq3lTLdyW6dOrNEdR3MzInH7Tf0WngVLzuDzouq0y3beKBNINhG1g/6GdLuI+BdOThgq1R/RilkfrMJWsAk0bUPe/Ljv4BUhXfT1Ifg3w3Lgo+5WTue8zMMtRIahJwJr0kaB+btENfRuTJEcgiQNnm943rNm2sAfePFUr/vc7owTeGZjI8bic6uyWGHIPBgdKhoLI5wH7uIPOBLHe+03d4HWIo9BHpsLzIEY83nsgSzrL5kNz7E9/wLUTIpr2ZsOFli+pPKyQPh0u3jUnrx1R2VDJFC+ZXSkFlY3OR7uEZ+dFH7K1WXASjDKqH2yXy46p9yN/TuehJ5Sp+KgwYJnOR4N+EuWT+pxDMTb1nJ+cqAWyCB1o0y3cGbWfnGuh31auDCYAmtvqO6iPM/neMtJ5Y5L5rRAwUzh2SdDRsvUSgFu+4Z+K5S+71NOXG7fFHqL4UhlJw62T6DBk+etQDVjbo2XyfdC5K5kYWjsgNZ0Wota7Mnk7Y5mUgT1KT6i5vCQsXbOmbpJgP2IQ6JQINJINkHmC389qCDTxGARUeNIqGKJHZNKuA8ZQv0Wokt2dSrlKLNgJ8n8xHIlYR+xbDHSLPowbtjOPXBrqeQzAU=
script:
- pwd
install:
- if [ ! -z "$PYTHON_PACKAGES" ]; then pip install --upgrade pip; pip install $PYTHON_PACKAGES;
  fi
- pip list
before_script:
- if [[ ${DOCKERHUB_USE_DEFAULT} == true ]]; then export DOCKERHUB_TAG=${DOCKERHUB_DEFAULT_REPO}:${DOCKERHUB_DEFAULT_TAGNAME};
  else export DOCKERHUB_TAG=${DOCKERHUB_USER_REPO}:${DOCKERHUB_USER_TAGNAME}; fi;
- echo ${DOCKERHUB_TAG}; echo ${GITHUB_REPO_ORG}; echo ${TRAVIS_REPO_SLUG}; echo ${TRAVIS_BUILD_DIR};
  echo ${OWNER_BUILD_DIR};
jobs:
  allow_failures:
  - stage: Documentation
  include:
  - stage: Documentation
    before_install: export PYTHON_PACKAGES="$PYTHON_PACKAGES sphinx_rtd_theme doc8"
    script:
    - doc8 docs/index.rst docs/Users_Guide/ docs/Contributors_Guide/
  - stage: Docker Setup
    name: Update Data Volumes
    before_install: export PYTHON_PACKAGES="$PYTHON_PACKAGES bs4 python-dateutil"
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/docker_update_data_volumes.py"
  - name: Get METplus Image
    script:
    - echo "$DOCKER_PASSWORD" $DOCKER_PASSWORD
    - echo "$DOCKER_USERNAME" $DOCKER_USERNAME
    - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/docker_setup.sh"
  - stage: Tests
    name: Pytest Unit Tests
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_unit.sh"
  - name: Use Case Tests - met_tool_wrapper
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_use_cases_met_tool_wrapper.sh"
  - name: Use Case Tests - data_assimilation
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_use_cases_data_assimilation.sh"
  - name: Use Case Tests - cryosphere
    script:
    - travis_wait 30 ${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_use_cases_model_applications.sh
      --cryosphere
  - name: Use Case Tests - convection_allowing_models
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_use_cases_model_applications.sh --convection_allowing_models"
  - name: Use Case Tests - climate
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_use_cases_model_applications.sh --climate"
  - name: Use Case Tests - medium_range1
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_use_cases_model_applications.sh --medium_range1"
  - name: Use Case Tests - medium_range2
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_use_cases_model_applications.sh --medium_range2"
  - name: Use Case Tests - medium_range3
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_use_cases_medium_range3.sh"
  - name: Use Case Tests - precipitation
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_use_cases_model_applications.sh --precipitation"
  - name: Use Case Tests - s2s, space_weather, tc_and_extra_tc
    script:
    - "${TRAVIS_BUILD_DIR}/ci/travis_jobs/test_use_cases_model_applications.sh --s2s
      --space_weather --tc_and_extra_tc"
